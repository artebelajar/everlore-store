<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
  </head>
  <body>
    <h1>Halaman Admin</h1>
    <button onclick="logout()">Logout</button>
    <hr />

    <p>Tambah Produk Baru</p>
    <hr />

    <form id="productForm">
      <label>Nama Produk:</label>
      <input type="text" id="name" required /><br /><br />

      <label>Deskripsi:</label>
      <textarea id="desc" required></textarea><br /><br />

      <label>Harga (Rp):</label>
      <input
        type="number"
        id="price"
        name="price"
        placeholder="Masukan Harga Produk"
        required
      /><br /><br />

      <label>Stok:</label>
      <input
        type="number"
        id="stock"
        name="stock"
        placeholder="Masukan Stok Produk"
        required
      /><br /><br />

      <label>Kategori:</label>
      <select id="category">
        <option value="1">Makanan</option>
        <option value="2">Minuman</option>
        <option value="3">Pakaian</option></select
      ><br /><br />

      <label>Gambar:</label><br />
      <input type="file" id="image" name="image" required /><br /><br />

      <button type="submit">Tambah Produk</button>
    </form>

    <br />
    <a href="/index.html">Ke Halaman Belanja</a>

    <h5>Product Anda</h5>
    <div id="product"></div>

    <script>
      const token = localStorage.getItem("token");

      if (!token) window.location.href = "/login.html";

      
      async function checkAuth() {
        try {
          const res = await fetch("/api/me", {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          if (res.success === false) {
            window.location.href = "./login.html";
          }
          const json = await res.json();
          return json.data.id;
        } catch (e) {
          window.location.href = "./login.html";
        }
        return false;
      }
      
      async function loadProduct() {
        const userId = await checkAuth();
        if (!userId) return;
        
        const res = await fetch(`/api/product/${userId}`);
        const json = await res.json();
        
        const product = json.data;
        console.log(product);
        
        document.getElementById("product").innerHTML = product
          .map(
            (product) => `
            <div style="border: 1px solid #ccc; padding: 10px; margin-bottom:10px">
              <img src="${product.imageUrl || ""}" width="150">
              <h3>${product.name}</h3>
              <p>${product.description ?? ""}</p>
              <p>Harga: Rp ${parseInt(product.price).toLocaleString()}</p>
              <p>Stok: ${product.stock ?? ""}</p>
              <button onclick="deleteProduct(${product.id})">Hapus</button>
              <button onclick="editProduct(${product.id})">Edit</button>
            </div>
            `,
          )
          .join("");
      };

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      }

      loadProduct();

      document
        .getElementById("productForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          console.log("bisa nih");

          const formData = new FormData();
          formData.append("name", document.getElementById("name").value);
          formData.append("description", document.getElementById("desc").value);
          formData.append("price", document.getElementById("price").value);
          formData.append("stock", document.getElementById("stock").value);
          formData.append(
            "categoryId",
            document.getElementById("category").value,
          );
          formData.append("image", document.getElementById("image").files[0]);
          formData.append("userId", await checkAuth());
          console.log("data udah kesimpen nih");

          const res = await fetch("/api/products", {
            method: "POST",
            headers: { Authorization: `Bearer ` + token },
            body: formData,
          });

          const data = await res.json();
          alert(data.message);

          if (data.success) location.reload();
        });

      (async () => {
        if (await checkAuth());
      })();
    </script>
  </body>
</html>
