<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
  </head>
  <body>
    <div id="modal" class="modal" style="display: none">
      <h1>Edit Produck <span id="name-product"></span></h1>
      <hr />
      <form id="productFormEdit">
        <label>Nama Produk:</label>
        <input type="text" id="nameEdit" required /><br /><br />

        <label>Deskripsi:</label>
        <textarea id="descEdit" required></textarea><br /><br />

        <label>Harga (Rp):</label>
        <input
          type="number"
          id="priceEdit"
          name="price"
          placeholder="Masukan Harga Produk"
          required
        /><br /><br />

        <label>Stok:</label>
        <input
          type="number"
          id="stockEdit"
          name="stock"
          placeholder="Masukan Stok Produk"
          required
        /><br /><br />

        <label>Kategori:</label>
        <select id="categoryEdit">
          <option value="1">Makanan</option>
          <option value="2">Minuman</option>
          <option value="3">Pakaian</option>
        </select>
        <br /><br />

        <label>Gambar Saat Ini:</label><br />
        <img id="imagePreview" width="150" style="margin-bottom: 10px" />
        <br />

        <label>Ganti Gambar (opsional):</label><br />
        <input type="file" id="imageEdit" name="image-now" accept="image/*" />
        <br /><br />

        <button type="submit">Ubah Produk</button>
      </form>
    </div>
    <h1>Halaman Admin</h1>
    <button onclick="logout()">Logout</button>
    <hr />

    <p>Tambah Produk Baru</p>
    <hr />

    <form id="productForm">
      <label>Nama Produk:</label>
      <input type="text" id="name" required /><br /><br />

      <label>Deskripsi:</label>
      <textarea id="desc" required></textarea><br /><br />

      <label>Harga (Rp):</label>
      <input
        type="number"
        id="price"
        name="price"
        placeholder="Masukan Harga Produk"
        required
      /><br /><br />

      <label>Stok:</label>
      <input
        type="number"
        id="stock"
        name="stock"
        placeholder="Masukan Stok Produk"
        required
      /><br /><br />

      <label>Kategori:</label>
      <select id="category">
        <option value="1">Makanan</option>
        <option value="2">Minuman</option>
        <option value="3">Pakaian</option></select
      ><br /><br />

      <label>Gambar:</label><br />
      <input type="file" id="image" name="image" required /><br /><br />

      <button type="submit">Tambah Produk</button>
    </form>

    <br />
    <a href="/index.html">Ke Halaman Belanja</a>

    <h5>Product Anda</h5>
    <div>
      <select name="filter" id="categoryFilter">
        <option value="all">Semua</option>
        <option value="makanan">Makanan</option>
        <option value="minuman">Minuman</option>
        <option value="pakaian">Pakaian</option>
      </select>
    </div>
    <hr />
    <div id="products"></div>

    <script>
      let allProducts = [];
      const token = localStorage.getItem("token");

      if (!token) window.location.href = "/login.html";

      async function checkAuth() {
        try {
          const res = await fetch("/api/me", {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          if (res.success === false) {
            window.location.href = "./login.html";
          }
          const json = await res.json();
          return json.data.id;
        } catch (e) {
          window.location.href = "./login.html";
        }
        return false;
      }

      async function loadProduct() {
        const userId = await checkAuth();
        if (!userId) return;

        const res = await fetch(`/api/product/${userId}`);
        const json = await res.json();
        allProducts = json.data;
        renderProducts(allProducts);
      }

      function renderProducts(products) {
        if (products.length === 0) {
          document.getElementById("products").innerHTML =
            "<p>Produk tidak tersedia</p>";
          return;
        }

        document.getElementById("products").innerHTML = products
          .map(
            (p) => `
        <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
            <img src="${p.imageUrl}" width="150" alt="${p.name}" ><br>
            <h3>${p.name}</h3>
            <p>${p.description}</p>
            <p>Harga: Rp ${parseInt(p.price).toLocaleString()}</p>
            <button onclick="add(${p.id})">Tambah (+)</button>
        </div>
        `,
          )
          .join("");
      }

      document
        .getElementById("categoryFilter")
        .addEventListener("change", function () {
          let value = this.value;

          if (value === "all") {
            renderProducts(allProducts);
            return;
          } else if (value === "makanan") {
            value = 1;
          } else if (value === "minuman") {
            value = 2;
          } else if (value === "pakaian") {
            value = 3;
          }

          const filtered = allProducts.filter(
            (p) => p.categoryId === Number(value),
          );

          renderProducts(filtered);
        });

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      }

      async function deleteProduct(id) {
        const res = await fetch(`/api/product/${id}`, {
          method: "DELETE",
        });
        const json = await res.json();
        if (json.success) {
          alert("Product berhasil dihapus");
          loadProduct();
        } else {
          alert("Product gagal dihapus");
        }
      }

      async function editProduct(id, userId) {
        document.getElementById("modal").style.display = "block";

        const res = await fetch(`/api/product/${userId}`);
        const json = await res.json();

        const product = json.data.find((p) => p.id === id);

        if (!product) {
          alert("Produk tidak ditemukan");
          return;
        }

        document.getElementById("nameEdit").value = product.name;
        document.getElementById("descEdit").value = product.description ?? "";
        document.getElementById("priceEdit").value = product.price;
        document.getElementById("stockEdit").value = product.stock;
        document.getElementById("name-product").innerText = product.name;
        document.getElementById("imagePreview").src = product.imageUrl;

        document
          .getElementById("productFormEdit")
          .addEventListener("submit", async function (e) {
            e.preventDefault();

            const formData = new FormData();
            formData.append("name", document.getElementById("nameEdit").value);
            formData.append(
              "description",
              document.getElementById("descEdit").value,
            );
            formData.append(
              "price",
              document.getElementById("priceEdit").value,
            );
            formData.append(
              "stock",
              document.getElementById("stockEdit").value,
            );
            formData.append(
              "categoryId",
              document.getElementById("categoryEdit").value,
            );
            formData.append(
              "image",
              document.getElementById("imageEdit").files[0],
            );
            formData.append("userId", userId);

            const res = await fetch(`/api/product/${id}`, {
              method: "PUT",
              headers: {
                Authorization: `Bearer ` + token,
              },
              body: formData,
            });

            const data = await res.json();
            alert(data.message);

            if (data.success) {
              loadProduct();
              document.getElementById("modal").style.display = "none";
            }
          });
      }

      document
        .getElementById("imageEdit")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            document.getElementById("imagePreview").src =
              URL.createObjectURL(file);
          }
        });

      document.getElementById("modal").addEventListener("click", function (e) {
        if (e.target === this) {
          this.style.display = "none";
        }
      });

      document
        .getElementById("productForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData();
          formData.append("name", document.getElementById("name").value);
          formData.append("description", document.getElementById("desc").value);
          formData.append("price", document.getElementById("price").value);
          formData.append("stock", document.getElementById("stock").value);
          formData.append(
            "categoryId",
            document.getElementById("category").value,
          );
          formData.append("image", document.getElementById("image").files[0]);
          formData.append("userId", await checkAuth());

          const res = await fetch("/api/products", {
            method: "POST",
            headers: { Authorization: `Bearer ` + token },
            body: formData,
          });

          const data = await res.json();
          alert(data.message);

          if (data.success) location.reload();
        });

      (async () => {
        const userId = await checkAuth();
        if (userId) loadProduct();
      })();
    </script>
  </body>
</html>
