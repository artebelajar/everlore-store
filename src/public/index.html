<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Toko Warga</title>
  </head>
  <body>
    <h1>Toko Warga</h1>
    <h2>Selamat Datang, <span id="username"></span></h2>
    <button onclick="logout()">Logout</button>
    <a href="./admin.html" id="admin" style="display: none">Product Anda</a>
    <button onclick="toggleCart()">
      Lihat Keranjang (<span id="count">0</span>)
    </button>
    <hr />

    <div
      id="cartModal"
      style="
        display: none;
        background: #eee;
        padding: 20px;
        border: 1px solid black;
        margin-bottom: 20px;
      "
    >
      <h3>keranjang Anda</h3>
      <div id="cartList"></div>
      <br />

      <label>Nama Pemesan:</label><br />
      <input type="text" id="cName" /><br /><br />

      <label>Alamat Pengirim:</label><br />
      <input type="text" id="cAddr" /><br /><br />

      <button onclick="checkout()">Beli Via Whatsapp</button>
      <button onclick="toggleCart()">Tutup</button>
    </div>
    <hr />

    <div>
      <select name="filter" id="categoryFilter">
        <option value="all">Semua</option>
        <option value="makanan">Makanan</option>
        <option value="minuman">Minuman</option>
        <option value="pakaian">Pakaian</option>
      </select>
    </div>
    <div id="products"></div>

    <script>
      let cart = [];
      let allProducts = [];

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "/login.html";
      }

      async function load() {
        const res = await fetch("/api/products");
        const json = await res.json();
        allProducts = json.data;
        renderProducts(allProducts);
      }

      // async function filter() {
      //   const filter = document.getElementById("filter").value;

      //   if (filter === "all") {
      //     load();
      //   } else if (filter === "makanan") {
      //     filter = 1;
      //   } else if (filter === "minuman") {
      //     filter = 2;
      //   } else if (filter === "pakaian") {
      //     filter = 3;
      //   }

      //   document.getElementById("products").innerHTML = allProducts
      //     .filter((p) => p.categoryId === filter)
      //     .map(
      //       (p) => `
      //       <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
      //           <img src="${p.imageUrl}" width="150" alt="${p.name}" ><br>
      //           <h3>${p.name}</h3>
      //           <p>${p.description}</p>
      //           <p>Harga: Rp ${parseInt(p.price).toLocaleString()}</p>
      //           <button onclick="add(${p.id})">Tambah (+)</button>
      //       </div>
      //       `,
      //     )
      //     .join("");
      // }

      function add(id) {
        const exist = cart.find((c) => c.productId === id);
        if (exist) exist.quantity++;
        else cart.push({ productId: id, quantity: 1 });
        updateCount();
      }

      function updateCount() {
        document.getElementById("count").innerText = cart.reduce(
          (a, b) => a + b.quantity,
          0,
        );
      }

      function toggleCart() {
        const m = document.getElementById("cartModal");
        if (m.style.display === "none") {
          m.style.display = "block";
          renderCartList();
        } else {
          m.style.display = "none";
        }
      }

      function renderProducts(products) {
        document.getElementById("products").innerHTML = products
          .map(
            (p) => `
      <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px">
        <img src="${p.imageUrl}" width="150"><br>
        <h3>${p.name}</h3>
        <p>${p.description ?? ""}</p>
        <p>Harga: Rp ${Number(p.price).toLocaleString("id-ID")}</p>
        <button onclick="add(${p.id})">Tambah (+)</button>
      </div>
    `,
          )
          .join("");
      }

      document
        .getElementById("categoryFilter")
        .addEventListener("change", function () {
          let value = this.value;

          if (value === "all") {
            renderProducts(allProducts);
            return;
          } else if (value === "makanan") {
            value = 1;
          } else if (value === "minuman") {
            value = 2;
          } else if (value === "pakaian") {
            value = 3;
          }

          const filtered = allProducts.filter(
            (p) => p.categoryId === Number(value),
          );

          renderProducts(filtered);
        });

      function renderCartList() {
        document.getElementById("cartList").innerHTML = cart
          .map((c) => {
            const p = allProducts.find((x) => x.id === c.productId);
            return `<div>
                ${p.name} (x${c.quantity}) - Rp ${(p.price * c.quantity).toLocaleString()}
                <div/>`;
          })
          .join("");
      }

      async function checkout() {
        const name = document.getElementById("cName").value;
        const addr = document.getElementById("cAddr").value;
        if (!name || !addr || cart.length === 0)
          return alert("Data belum lengkap / keranjang kosong");

        const res = await fetch("/api/orders", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            customerName: name,
            address: addr,
            items: cart,
          }),
        });
        const data = await res.json();
        console.log(data);

        if (data.success) {
          const msg = `halo Admin, Order ID #${data.orderId}. Total: ${data.total.toLocaleString()}. Dikirim ke: ${addr}`;
          window.location.href = `https://wa.me/6285752214806?text=${encodeURIComponent(msg)}`;
        }
      }

      async function checkAuth() {
        try {
          const res = await fetch("/api/me", {
            headers: {
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
          });
          const json = await res.json();
          if (json.success) {
            if (json.data.role === "admin") {
              document.getElementById("admin").style.display = "block";
            }

            document.getElementById("username").textContent =
              json.data.username;
            return true;
          } else {
            window.location.href = "./login.html";
          }
          load();
        } catch (e) {
          window.location.href = "./login.html";
        }
        return false;
      }

      (async () => {
        if (await checkAuth()) load();
      })();
    </script>
  </body>
</html>
